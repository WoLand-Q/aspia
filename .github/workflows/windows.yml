name: windows

on:
  push:
    branches:
      - master
      - "smartcafe/**"
    paths-ignore:
      - 'README.md'
      - 'LICENSE.md'
      - 'CONTRIBUTING.md'
      - 'CODE_OF_CONDUCT.md'
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  VCPKG_INSTALLED_DIR: ${{ github.workspace }}/builds/ninja-vcpkg-ci/vcpkg_installed
  VCPKG_ROOT_PROJECT: ${{ github.workspace }}/vcpkg4aspia
  VCPKG_BINARY_SOURCES: 'default,readwrite'

jobs:
  build-all-matrix:
    name: ${{ matrix.arch }}-${{ matrix.build_type }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86, x64]
        build_type: [release]
        include:
          - arch: x86
            triplet: x86-windows-static
          - arch: x64
            triplet: x64-windows-static

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Checkout vcpkg4aspia
        uses: actions/checkout@v4
        with:
          repository: dchapyshev/vcpkg4aspia
          path: vcpkg4aspia

      - name: Set MSVC x86/x64 parameters
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}
          toolset: 14.44

      - name: Install build tools (CMake 4+, Ninja, WiX)
        shell: pwsh
        run: |
          choco install cmake ninja wixtoolset --no-progress -y

          $cmakeBin = "${env:ProgramFiles}\\CMake\\bin"
          if (Test-Path $cmakeBin) { Add-Content $env:GITHUB_PATH $cmakeBin }

          $wixCandle = Get-ChildItem -Path "${env:ProgramFiles(x86)}" -Recurse -Filter candle.exe -ErrorAction SilentlyContinue |
            Select-Object -First 1
          if (-not $wixCandle) { throw "WiX candle.exe not found after install." }

          $wixRoot = Split-Path (Split-Path $wixCandle.FullName -Parent) -Parent
          Add-Content $env:GITHUB_ENV "WIX=$wixRoot"

          cmake --version
          ninja --version

      - name: Ensure WDK headers are available
        shell: pwsh
        run: |
          $kitInclude = "${env:ProgramFiles(x86)}\\Windows Kits\\10\\Include"

          function Test-WdkPresent {
            param([string]$Root)
            $wudf = Get-ChildItem -Path $Root -Recurse -Filter wudfwdm.h -ErrorAction SilentlyContinue | Select-Object -First 1
            $wdf  = Get-ChildItem -Path (Join-Path $Root "wdf") -Recurse -Filter wdf.h -ErrorAction SilentlyContinue | Select-Object -First 1
            return ($null -ne $wudf -and $null -ne $wdf)
          }

          if (Test-WdkPresent -Root $kitInclude) {
            Write-Host "WDK headers already present."
            exit 0
          }

          Write-Host "WDK headers not found, installing WDK via winget..."
          winget --version
          winget source update

          # WDK is distributed in winget with a versioned Id (no unversioned Microsoft.WindowsWDK).
          $wdkIds = @(
            "Microsoft.WindowsWDK.10.0.26100",
            "Microsoft.WindowsWDK.10.0.22621",
            "Microsoft.WindowsWDK.10.0.22000",
            "Microsoft.WindowsWDK.10.0.19041"
          )

          $installed = $false
          foreach ($id in $wdkIds) {
            Write-Host "Trying: $id"
            winget install --source winget --exact --id $id --accept-package-agreements --accept-source-agreements --silent
            if ($LASTEXITCODE -eq 0) { $installed = $true; break }
            Write-Host "Install failed for $id (exit code $LASTEXITCODE)."
          }

          if (-not $installed) {
            throw "Unable to install WDK via winget. Tried: $($wdkIds -join ', ')"
          }

          if (-not (Test-WdkPresent -Root $kitInclude)) {
            throw "WDK headers not found after install."
          }

      - name: Cache vcpkg downloads/binaries
        uses: actions/cache@v4
        with:
          path: |
            C:\vcpkg\bincache-${{ matrix.triplet }}
            C:\vcpkg\downloads
          key: vcpkg-${{ runner.os }}-${{ matrix.triplet }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-${{ matrix.triplet }}-

      - name: Dependencies, Build, Tests (Windows/PowerShell)
        env:
          VCPKG_DEFAULT_BINARY_CACHE: C:\vcpkg\bincache-${{ matrix.triplet }}
          VCPKG_TRIPLET: ${{ matrix.triplet }}
          VCPKG_DEFAULT_HOST_TRIPLET: ${{ matrix.triplet }}
          VCPKG_DOWNLOADS: C:\vcpkg\downloads
        run: |
          $env:VCPKG_ROOT=$env:VCPKG_ROOT_PROJECT

          if (!$env:VCPKG_TRIPLET) { echo "VCPKG_TRIPLET is empty"; exit 1; }

          New-Item -ItemType Directory -Force -Path $env:VCPKG_DEFAULT_BINARY_CACHE
          New-Item -ItemType Directory -Force -Path $env:VCPKG_DOWNLOADS

          cmake --preset ninja-vcpkg-ci
          cmake --build --preset ninja-vcpkg-ci-${{ matrix.build_type }}
          ctest --preset ninja-vcpkg-ci-${{ matrix.build_type }}

      - name: Verify build artifacts exist
        shell: pwsh
        run: |
          $binDir = Join-Path $env:GITHUB_WORKSPACE "builds\\ninja-vcpkg-ci\\Release"
          if (-not (Test-Path $binDir)) { throw "Build output directory not found: $binDir" }

          $required = @(
            "smartcafe_router.exe",
            "smartcafe_relay.exe",
            "smartcafe_sha256.exe",
            "smartcafe_client.exe",
            "smartcafe_console.exe",
            "smartcafe_host.exe"
          )

          $missing = @()
          foreach ($file in $required) {
            if (-not (Test-Path (Join-Path $binDir $file))) { $missing += $file }
          }

          if ($missing.Count -gt 0) {
            throw "Missing artifacts in ${binDir}: $($missing -join ', ')"
          }

      - name: Build MSI packages
        run: |
          set BIN_DIR=%GITHUB_WORKSPACE%\builds\ninja-vcpkg-ci\Release
          installer\build.cmd 3.0.0 ${{ matrix.arch }} %GITHUB_WORKSPACE% %BIN_DIR%
        shell: cmd
        working-directory: ${{ github.workspace }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: smartcafe-msi-${{ matrix.arch }}
          path: |
            ${{ github.workspace }}/builds/ninja-vcpkg-ci/Release/*-${{ matrix.arch }}.msi
          if-no-files-found: error
          retention-days: 7
